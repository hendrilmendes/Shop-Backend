<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Produto</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .navbar {
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .navbar .nav-wrapper {
            padding: 0 20px;
        }

        .container {
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 80px;
            /* Ajuste para não ficar embaixo da nav */
        }

        h1 {
            color: black;
            text-align: center;
            font-size: 24px;
            margin-bottom: 30px;
            border-bottom: 2px solid #6200ea;
            padding-bottom: 10px;
        }

        .input-field {
            margin-bottom: 20px;
        }

        .input-field input,
        .input-field textarea,
        .input-field select,
        .input-field select option {
            color: black;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none;
            transition: opacity 0.5s ease;
            position: relative;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .message-icon {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
        }

        .message-content {
            margin-left: 40px;
        }

    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-wrapper purple darken-3">
            <a href="http://localhost/web" class="brand-logo">ShopTem</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="http://localhost/web">Início</a></li>
                <li><a href="http://localhost/web/products/add.html">Cadastrar Produtos</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1>Editar Produto</h1>
        <form id="editProductForm">
            <div class="input-field">
                <input type="text" id="productId" name="id" required readonly>
                <label for="productId">Código do Produto</label>
            </div>
            <div class="input-field">
                <input type="text" id="title" name="title" required>
                <label for="title">Título</label>
            </div>
            <div class="input-field">
                <textarea id="description" name="description" class="materialize-textarea" required></textarea>
                <label for="description">Descrição</label>
            </div>
            <div class="input-field">
                <input type="number" id="price" name="price" step="0.01" required>
                <label for="price">Preço</label>
            </div>
            <div class="input-field">
                <input type="number" id="discount" name="discount" step="0.01" required>
                <label for="discount">Desconto (%)</label>
            </div>
            <div class="input-field">
                <input type="text" id="imageUrls" name="imageUrls" required>
                <label for="imageUrls">URLs das Imagens (separadas por vírgulas)</label>
            </div>
            <div class="input-field">
                <input type="text" id="colors" name="colors" required>
                <label for="colors">Cores (separadas por vírgulas)</label>
            </div>
            <div class="input-field">
                <input type="text" id="sizes" name="sizes" required>
                <label for="sizes">Tamanhos (separados por vírgulas)</label>
            </div>
            <div class="input-field">
                <input type="number" id="shippingCost" name="shippingCost" step="0.01" required>
                <label for="shippingCost">Custo de Envio</label>
            </div>
            <div class="input-field">
                <select id="category" name="category" required></select>
                <label for="category">Categoria</label>
            </div>
            <div class="input-field">
                <select id="isOutOfStock" name="isOutOfStock" required>
                    <option value="false">Não</option>
                    <option value="true">Sim</option>
                </select>
                <label for="isOutOfStock">Fora de Estoque</label>
            </div>

            <button type="submit" class="btn waves-effect waves-light">Salvar</button>
            <button type="button" id="deleteProduct" class="btn red waves-effect waves-light">Excluir Produto</button>
        </form>
        <div id="message" class="message">
            <span class="message-icon"><i class="material-icons">info_outline</i></span>
            <span class="message-content">Mensagem aqui</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            M.updateTextFields();
            M.FormSelect.init(document.querySelectorAll('select'));

            loadCategories();

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (productId) {
                fetchProductDetails(productId);
            }

            document.getElementById('editProductForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                updateProduct();
            });

            document.getElementById('deleteProduct').addEventListener('click', () => {
                deleteProduct(productId);
            });
        });

        async function fetchProductDetails(productId) {
            try {
                const response = await fetch(`http://localhost:3000/api/products/${productId}`);
                const product = await response.json();

                if (product.message) {
                    throw new Error(product.message);
                }

                document.getElementById('productId').value = product.id;
                document.getElementById('title').value = product.title;
                document.getElementById('description').value = product.description;
                document.getElementById('price').value = product.price;
                document.getElementById('discount').value = product.discount;
                document.getElementById('imageUrls').value = product.imageUrls.join(',');
                document.getElementById('colors').value = product.colors.join(',');
                document.getElementById('sizes').value = product.sizes.join(',');
                document.getElementById('shippingCost').value = product.shippingCost;
                document.getElementById('isOutOfStock').value = product.isOutOfStock.toString();

                // Aguarda o carregamento das categorias
                await loadCategories();

                const categorySelect = document.getElementById('category');

                // Define o valor selecionado
                // Verifica se a categoria está presente nas opções
                const options = Array.from(categorySelect.options);
                const categoryOption = options.find(option => option.value === product.category);
                if (categoryOption) {
                    categorySelect.value = product.category;
                } else {
                    console.warn('Categoria não encontrada nas opções:', product.category);
                }

                // Força a re-inicialização do seletor
                M.FormSelect.init(categorySelect);

            } catch (error) {
                showMessage('Erro ao buscar dados: ' + error.message, 'error');
            }
        }
        
        async function updateProduct() {
            const id = document.getElementById('productId').value;
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const price = document.getElementById('price').value;
            const discount = document.getElementById('discount').value;
            const imageUrls = document.getElementById('imageUrls').value.split(',');
            const colors = document.getElementById('colors').value.split(',');
            const sizes = document.getElementById('sizes').value.split(',');
            const shippingCost = document.getElementById('shippingCost').value;
            const category = document.getElementById('category').value;
            const isOutOfStock = document.getElementById('isOutOfStock').value === 'true';

            try {
                const response = await fetch(`http://localhost:3000/api/products/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        price,
                        discount,
                        imageUrls,
                        colors,
                        sizes,
                        shippingCost,
                        category,
                        isOutOfStock
                    })
                });
                const result = await response.json();

                if (result.message) {
                    throw new Error(result.message);
                }

                showMessage('Produto atualizado com sucesso!', 'success');
            } catch (error) {
                showMessage('Erro ao atualizar produto: ' + error.message, 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Tem certeza de que deseja excluir este produto?')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/products/${productId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.message) {
                    throw new Error(result.message);
                }

                showMessage('Produto excluído com sucesso!', 'success');
                // Redireciona para a página inicial após a exclusão
                setTimeout(() => window.location.href = 'index.html', 2000);
            } catch (error) {
                showMessage('Erro ao excluir produto: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            const messageContent = messageDiv.querySelector('.message-content');
            messageContent.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.opacity = 0;
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                    messageDiv.style.opacity = 1;
                }, 500);
            }, 3000);
        }

        async function loadCategories() {
            try {
                const response = await fetch('http://localhost:3000/api/categories');
                const categories = await response.json();

                const categorySelect = document.getElementById('category');
                categorySelect.innerHTML = '<option value="" disabled selected>Escolha uma Categoria</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });

                M.FormSelect.init(categorySelect);
            } catch (error) {
                showMessage('Erro ao carregar categorias: ' + error.message, 'error');
            }
        }
    </script>
</body>

</html>
